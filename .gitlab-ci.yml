.docker_boostrap: &docker_boostrap |
  [[ ! -e /.dockerenv ]] && exit 0
  set -xe
    
  # Install git (the php image doesn't have it) which is required by composer
  apt-get update -yq
  apt-get install git wget procps unzip -y

  # Install pcntl and redis extentions
  pecl install -o -f redis \
  &&  rm -rf /tmp/pear \
  &&  docker-php-ext-enable redis
  docker-php-ext-install pcntl

  # Install Composer
  wget https://getcomposer.org/composer.phar
  php composer.phar install --dev

services:
  - redis:latest

# Test PHP 7.4
test:7.4:
  image: php:7.4
  before_script:
    - *docker_boostrap
  script:
    - php vendor/bin/phpunit --verbose --configuration phpunit.xml
  tags:
    - docker

# Test PHP 8.0
test:8.0:
  image: php:8.0
  before_script:
    - *docker_boostrap
  script:
    - php vendor/bin/phpunit --verbose --configuration phpunit.xml
  tags:
    - docker

# Codestandards
lint:
  image: php:8.0
  allow_failure: true
  script:
    - apt update && apt install -y wget unzip git
    - wget https://getcomposer.org/composer.phar
    - php composer.phar install --dev
    - php -d memory_limit=256M vendor/bin/phpcs -s --standard=ruleset.xml